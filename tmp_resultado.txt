/* ✅ Premium VPS Optimization applied: UTF-8 fixed, visuals enhanced, risk-impact communication added, and PDF results improved. */
/* ✅ Updated by Codex: 5S feedback text simplified and enhanced for leadership and operators. */

// Utilidades numéricas
function formatNumber(n) { return new Intl.NumberFormat('pt-BR', { maximumFractionDigits: 2 }).format(n); }
function formatOne(n) { return new Intl.NumberFormat('pt-BR', { minimumFractionDigits: 1, maximumFractionDigits: 1 }).format(n); }

// Classificação Vale 5S (0–3) – cor, rótulo e descrição curtas
function getMaturityLevel(score) {
  if (score == null || Number.isNaN(score)) return { level: 'NA', label: 'N/A', color: '#9ca3af', desc: 'Sem dados suficientes.' };
  // Regra estrita: exatamente 1.0 é crítico
  if (score === 1.0) return { level: 'M1', label: 'Crítico', color: '#D32F2F', desc: 'Situação crítica. Ação imediata do gestor.' };
  if (score <= 0.9)  return { level: 'M1', label: 'Crítico',  color: '#D32F2F', desc: 'Falhas graves. Atue imediatamente.' };
  if (score <= 1.7)  return { level: 'M2', label: 'Regular',  color: '#FFC107', desc: 'Há práticas, porém com variação. Padronize.' };
  if (score <= 2.5)  return { level: 'M3', label: 'Bom',      color: '#1976D2', desc: 'Boas práticas. Há ganhos com padronização.' };
  return { level: 'M4', label: 'Excelente', color: '#00C853', desc: 'Padrão de excelência. Sustente e compartilhe.' };
}

// Regra de restrição (VPS): conta sensos críticos
function calculateOverallMaturity(sensosMap) {
  const values = Object.values(sensosMap).filter(v => typeof v === 'number');
  const avg = values.length ? values.reduce((a, b) => a + b, 0) / values.length : null;
  const criticalCount = values.filter(v => v <= 1.0).length;
  if (criticalCount >= 2) return { level: 'M1', label: 'Crítico', color: '#D32F2F', score: avg, desc: 'Múltiplos sensos críticos. Ação imediata.' };
  if (criticalCount === 1) return { level: 'M2', label: 'Regular', color: '#FFC107', score: avg, desc: 'Um senso crítico limita o resultado geral.' };
  const base = getMaturityLevel(avg); return { ...base, score: avg };
}

document.addEventListener('DOMContentLoaded', () => {
  const overallCard  = document.getElementById('overallCard');
  const canvas       = document.getElementById('chartSenso');
  const feedbackWrap = document.getElementById('feedback');
  const mount        = document.getElementById('dados-resumo');
  const btnRedo      = document.getElementById('btnRedo');
  const btnHome      = document.getElementById('btnHome');
  const btnCSV       = document.getElementById('btnExportCSV');
  const btnPDF       = document.getElementById('btnExportPDF');

  const data = safeReadLocal('meta5S');
  if (!data || !data.senses) { if (overallCard) overallCard.textContent = 'Nenhum resultado encontrado. Faça o diagnóstico novamente.'; return; }

  const senseKeys   = ['utilizacao','organizacao','limpeza','padronizacao','disciplina'];
  const senseTitles = { utilizacao:'Utilização', organizacao:'Organização', limpeza:'Limpeza', padronizacao:'Padronização', disciplina:'Disciplina' };
  const senseAverages = senseKeys.map(k => { const avg = data.senses[k]?.totals?.avg; return { key:k, title:senseTitles[k], avg: typeof avg === 'number' ? avg : null }; });
  const sensosMap = senseAverages.reduce((acc, s)=> (acc[s.key] = s.avg, acc), {});
  const overallMat = calculateOverallMaturity(sensosMap);

  // Nota Geral
  if (overallCard) {
    const avgText = overallMat.score != null ? formatOne(overallMat.score) : '-';
    const interpret = (overallMat.level === 'M4') ? 'Cultura 5S consolidada. Mantenha e compartilhe.'
                    : (overallMat.level === 'M3') ? 'Bom desempenho. Padronize para reduzir variações.'
                    : (overallMat.level === 'M2') ? 'Regular. Há práticas, porém variáveis. Corrija desvios.'
                    : 'Crítico. Ação imediata do gestor em campo.';
    overallCard.style.borderLeft = `4px solid ${overallMat.color}`;
    overallCard.style.boxShadow  = `0 8px 22px ${overallMat.color}33`;
    const alert = (overallMat.level === 'M1' || overallMat.level === 'M2')
      ? `<p id="overall-alert" style="margin:6px 0 0;color:${overallMat.color};"><strong>${overallMat.level==='M1'?'Ação imediata':'Atenção'}:</strong> ${overallMat.desc}</p>`
      : '';
    overallCard.innerHTML = `
      <div class="stack">
        <h3>Nota Geral</h3>
        <div style="display:flex;align-items:center;gap:12px;flex-wrap:wrap;">
          <div class="overall-score" style="font-size:1.6rem;font-weight:700;">${avgText}</div>
          <span class="overall-status button" style="border-color:transparent;background:${overallMat.color};color:#fff;">${overallMat.level} – ${overallMat.label}</span>
        </div>
        <p style="margin:6px 0 0;color:#e5e7eb">${interpret}</p>
        ${alert}
        <small style="color:#9ca3af">Média simples dos cinco sensos (0–3)</small>
      </div>`;
  }

  // Gráfico
  if (canvas && window.Chart) {
    const ctx     = canvas.getContext('2d');
    const labels  = senseAverages.map(s => s.title);
    const values  = senseAverages.map(s => (typeof s.avg === 'number' ? Number(s.avg.toFixed(2)) : 0));
    const infos   = senseAverages.map(s => getMaturityLevel(s.avg));
    const colors  = infos.map(i => i.color);
    try { window.Chart.register(window.ChartDataLabels); } catch {}
    const excellenceLine = { type:'line', yMin:2.6, yMax:2.6, borderColor:'#00C853', borderWidth:2, borderDash:[6,4], label:{enabled:true,content:'Meta de Excelência (2.6)',position:'end',color:'#00C853'} };
    new window.Chart(ctx, {
      type:'bar',
      data:{ labels, datasets:[{ label:'Média (0–3) por Senso', data:values, backgroundColor:colors, borderColor:colors, borderWidth:1 }] },
      options:{
        responsive:true, maintainAspectRatio:false,
        plugins:{
          legend:{ display:false },
          tooltip:{ callbacks:{ label:(tt)=>{ const i=tt.dataIndex; const info=infos[i]; return ` ${tt.formattedValue} – ${info.level} ${info.label}`; }, labelColor:(tt)=>{ const c=colors[tt.dataIndex]; return { borderColor:c, backgroundColor:c }; } } },
          datalabels:{ color:(ctx)=> (infos[ctx.dataIndex]?.level==='M2' ? '#fff' : colors[ctx.dataIndex]), anchor:'end', align:'top', formatter:(v)=> (v||v===0?Number(v).toFixed(1):''), font:(ctx)=>({weight:'600', size: ctx.chart.width<380?9:(ctx.chart.width<640?10:11)}) },
          annotation:{ annotations:{ excellence: excellenceLine } }
        },
        scales:{ y:{ suggestedMin:0, suggestedMax:3, ticks:{ stepSize:0.5, color:'#9ca3af' }, grid:{ color:'rgba(255,255,255,0.06)' } }, x:{ ticks:{ color:'#cbd5e1' }, grid:{ display:false } } }
      },
      plugins:[window.ChartDataLabels].filter(Boolean)
    });
  }

  // Feedback por senso (somente texto – visual intacto)
  if (feedbackWrap) {
    feedbackWrap.innerHTML = senseAverages.map((s)=>{
      const m   = getMaturityLevel(s.avg);
      const cls = m.level.toLowerCase(); // m1..m4 para estilos
      const T   = getSenseTexts(s.key);
      const insight = (m.level==='M4') ? 'Excelente gestão do posto. Padrão consistente e sustentável.'
                   : (m.level==='M3') ? 'Boas práticas aplicadas. Padronize para reduzir variação.'
                   : (m.level==='M2') ? 'Há práticas, porém variáveis. Defina padrão e corrija desvios.'
                   : 'Nível crítico. Impacto em segurança, fluxo e custos – agir já.';
      return `
        <div class="senso-card ${cls}" style="--tone:${m.color}">
          <div class="senso-card__header">
            <span class="level-badge" style="background:${m.color}">${m.level}</span>
            <h4>${s.title} — ${m.label}</h4>
          </div>
          <p class="insight">${insight}</p>
          <div class="senso-sections">
            <div class="sec gains"><strong>Ganhos:</strong>
              <ul>${T.ganhos.map(t=>`<li>${t}</li>`).join('')}</ul>
            </div>
            <div class="sec risks"><strong>Riscos & Perdas:</strong>
              <ul>${T.riscos.map(t=>`<li>${t}</li>`).join('')}</ul>
            </div>
            <div class="sec actions"><strong>Ações Recomendadas:</strong>
              <ul>${T.acoes.map(t=>`<li>${t}</li>`).join('')}</ul>
            </div>
          </div>
        </div>`;
    }).join('');
  }

  // Resumo (data/hora)
  if (mount) {
    const quando = data.meta?.geradoEm ? new Date(data.meta.geradoEm).toLocaleString('pt-BR') : '-';
    mount.innerHTML = `<div style="color:#9ca3af"><em>Gerado em:</em> ${quando}</div>`;
  }

  // Ações
  btnRedo?.addEventListener('click', () => { try { localStorage.removeItem('respostas5S'); localStorage.removeItem('meta5S'); } catch{}; window.location.href = 'diagnostico.html'; });
  btnHome?.addEventListener('click', () => { window.location.href = 'index.html'; });
  btnCSV ?.addEventListener('click', () => { try { exportCSV(data); } catch(e){ console.error(e); } });
  btnPDF ?.addEventListener('click', () => { try { generatePDF(); } catch(e){ console.error(e); alert('Não foi possível gerar o PDF automaticamente.'); } });
});

// Conteúdo por senso (PT‑BR simples, motivacional)
function getSenseTexts(key){
  const UTIL = {
    ganhos:[
      'Menos acúmulo de materiais → área de trabalho mais limpa e segura.',
      'Facilidade para encontrar o que é realmente usado.',
      'Fluxo produtivo mais rápido e previsível.',
      'Equipe mais focada e ambiente visualmente organizado.'
    ],
    riscos:[
      'Guardar itens sem uso ocupa espaço e atrapalha o trabalho.',
      'Materiais esquecidos podem causar tropeços, atrasos e acidentes.',
      'Dificulta identificar o que realmente precisa de reposição.'
    ],
    acoes:[
      'Faça “caixas vermelhas” semanais para separar o que não é usado.',
      'Descarte, recicle ou devolva materiais parados.',
      'Treine a equipe para reconhecer e eliminar excessos no posto.'
    ]
  };
  const ORG = {
    ganhos:[
      'Redução de tempo gasto procurando ferramentas.',
      'Padronização das áreas melhora a troca de turno e auditorias.',
      'Ambiente visualmente agradável e mais seguro.'
    ],
    riscos:[
      'Itens fora do lugar confundem e atrasam o trabalho.',
      'Falta de etiquetas ou endereçamento gera retrabalho.',
      'Dificulta inspeções e manutenção de rotina.'
    ],
    acoes:[
      'Use identificação visual simples: etiquetas, cores e placas.',
      'Crie mapas das áreas e atualize quando houver mudanças.',
      'Audite semanalmente a disposição dos itens junto à equipe.'
    ]
  };
  const LIM = {
    ganhos:[
      'Menor risco de falhas e acidentes.',
      'Equipamentos duram mais e exigem menos manutenção.',
      'Melhora o moral da equipe e a imagem da área.'
    ],
    riscos:[
      'Poeira e óleo escondem vazamentos e desgastes.',
      'Equipamentos sujos perdem rendimento e geram retrabalho.',
      'Acúmulo de lixo e resíduos causa riscos de contaminação.'
    ],
    acoes:[
      'Defina responsáveis por cada área de limpeza.',
      'Crie um “mapa de pontos críticos” e revise semanalmente.',
      'Estimule a cultura: “ver sujo é agir”.'
    ]
  };
  const PAD = {
    ganhos:[
      'Atividades mais previsíveis e seguras.',
      'Reduz erros em tarefas repetitivas.',
      'Facilita o treinamento de novos colaboradores.'
    ],
    riscos:[
      'Falta de padrões visuais causa confusão entre equipes.',
      'Dificulta auditorias e compartilhamento de boas práticas.',
      'Maior variação nos resultados e retrabalho.'
    ],
    acoes:[
      'Crie padrões visuais (checklists, fotos, fluxos).',
      'Compare práticas entre turnos e equipes.',
      'Atualize os padrões sempre que houver melhoria.'
    ]
  };
  const DIS = {
    ganhos:[
      'Sustentação dos resultados 5S e redução de reincidências.',
      'Melhoria contínua e cultura de responsabilidade.',
      'Equipe mais engajada e comprometida.'
    ],
    riscos:[
      'Falta de acompanhamento faz o 5S “voltar atrás”.',
      'Equipe perde credibilidade quando o padrão não é seguido.',
      'Resultados se tornam inconsistentes.'
    ],
    acoes:[
      'Crie rotina de auditoria 5S (quinzenal ou mensal).',
      'Valorize boas práticas publicamente.',
      'Corrija desvios com diálogo e reforço positivo.'
    ]
  };
  switch (key){ case 'utilizacao': return UTIL; case 'organizacao': return ORG; case 'limpeza': return LIM; case 'padronizacao': return PAD; case 'disciplina': return DIS; default: return ORG; }
}

// CSV
function exportCSV(data){
  const lines = ['Senso;Pergunta;Resposta;Nota'];
  const s = data.senses || {};
  Object.keys(s).forEach(key => {
    (s[key].questions || []).forEach(q => {
      const ans = (q.answerRaw === 'NA') ? 'NA' : (q.score ?? '');
      lines.push(`${s[key].title};"${q.text}";${q.answerRaw};${ans}`);
    });
  });
  const blob = new Blob([lines.join('\n')], { type: 'text/csv;charset=UTF-8' });
  const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = 'respostas-5s10x.csv'; a.click(); URL.revokeObjectURL(url);
}

// PDF (html2canvas + jsPDF) – multipágina, com dados do usuário
async function generatePDF(){
  const area = document.getElementById('resultado');
  const canvas = await html2canvas(area, { scale: 2, backgroundColor: '#0b1220', useCORS: true });
  const { jsPDF } = window.jspdf; const pdf = new jsPDF({ orientation: 'p', unit: 'pt', format: 'a4' });
  const pageW = pdf.internal.pageSize.getWidth(); const pageH = pdf.internal.pageSize.getHeight();
  const margin = 28; const headerH = 72; const footerH = 22; const usableW = pageW - margin * 2;

  const info = getProfileInfo();
  pdf.setFont('helvetica','bold'); pdf.setFontSize(14); pdf.text('Diagnóstico 5S 10X – Avaliação VPS', margin, margin + 12);
  pdf.setFont('helvetica','normal'); pdf.setFontSize(10);
  pdf.text(`Gerado em ${new Date().toLocaleString('pt-BR')}`, margin, margin + 28);
  pdf.text(`Nome: ${info.name || '-'}`, margin, margin + 42);
  pdf.text(`E-mail: ${info.email || '-'}`, margin, margin + 56);
  pdf.text(`Empresa/Posto: ${info.company || '-'}`, margin, margin + 70);

  const scale = usableW / canvas.width; const pageCanvasHeightPx = (pageH - headerH - footerH - margin) / scale;
  let offset = 0; let pageIndex = 0;
  while (offset < canvas.height) {
    const sliceHeight = Math.min(pageCanvasHeightPx, canvas.height - offset);
    const temp = document.createElement('canvas'); temp.width = canvas.width; temp.height = sliceHeight;
    const tctx = temp.getContext('2d'); tctx.drawImage(canvas, 0, -offset);
    const img = temp.toDataURL('image/png');
    const y = margin + headerH; if (pageIndex > 0) pdf.addPage();
    pdf.addImage(img, 'PNG', margin, y, usableW, sliceHeight * scale);
    pdf.setFont('helvetica','italic'); pdf.setFontSize(8);
    pdf.text('Desenvolvido por Adonias Pereira da Silva | FullStack Ambiental 10X', margin, pageH - 8);
    offset += sliceHeight; pageIndex += 1;
  }
  pdf.save(`Diagnostico5S10X_${getProfileName()}_${getDateYmd()}.pdf`);
}

// Perfil do usuário (homepage)
function getProfileInfo(){ try { const p = JSON.parse(localStorage.getItem('perfil5S')||'{}'); return { name:p.name||'', email:p.email||'', company:p.company||p.empresa||p.obra||'' }; } catch { return { name:'', email:'', company:'' }; } }
function getProfileName(){ const n = getProfileInfo().name || 'usuario'; return n.replace(/\s+/g,'_'); }
function getDateYmd(){ const d = new Date(); const pad=(n)=>String(n).padStart(2,'0'); return `${d.getFullYear()}${pad(d.getMonth()+1)}${pad(d.getDate())}`; }
function safeReadLocal(k){ try { const r = localStorage.getItem(k); return r? JSON.parse(r): null; } catch { return null; } }

