<!doctype html>
<html lang="pt-BR">
      <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet" crossorigin><meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Resultado - 5S 10X</title>
    <link rel="stylesheet" href="css/style.css" />
    <style>
      /* helpers (não alteram seu visual existente) */
      #resultado { scroll-margin-top: 24px; }
      [data-html2canvas-ignore="true"] { /* marcador para excluir do PDF */ }
    </style>
  </head>

  <body>
    <!-- ====== HEADER ====== -->
    <header class="container">
      <h1>Resultado</h1>
      <nav>
        <a href="index.html" class="link">Início</a>
        <a href="diagnostico.html" class="link">Novo diagnóstico</a>
      </nav>
    </header>

    <!-- ====== REPORT (somente esta seção entra no PDF) ====== -->
    <main class="container">
      <section class="card" id="resultado">
        <div id="dados-resumo" class="stack" style="margin-top:0;margin-bottom:8px;"></div>
        <h2>Resumo</h2>

        <!-- preenchido pelo js/resultado.js -->
        <div id="overallCard" class="card" style="margin-top:12px;"></div>

        <div class="card" style="margin-top:12px;">
          <h3>Desempenho por Senso</h3>
          <div class="stack" style="margin-top:8px;">
            <div style="position:relative;width:100%;height:340px;">
              <canvas id="chartSenso"></canvas>
            </div>
          </div>
        </div>

        <div id="feedback" class="stack" style="margin-top:12px;"></div>

        <div class="actions" style="margin-top:16px;">
          <button id="btnExportCSV" class="button" type="button">Exportar CSV</button>
          <button id="btnExportPDF" class="button" type="button">Exportar PDF</button>
          <button id="btnRedo" class="button" type="button">Refazer</button>
          <button id="btnHome" class="button" type="button">Início</button>
        </div>
      </section>
    </main>

    <!-- ====== CTA / Marketing (IGNORADOS no PDF) ====== -->
    <footer class="cta-footer" data-html2canvas-ignore="true">
      <div class="cta-content">
        <h2>?? Curtiu o seu diagnóstico 5S?</h2>
        <p>Conheça o <strong>Combo Produtividade 10X + Comunicação Persuasiva</strong>.</p>
        <a href="https://adoniasjoshua-collab.github.io/comboprodutividade5510x-meio-ambiente-comunica-o-influencia/"
           target="_blank" class="cta-button">Acessar Curso</a>
        <p>?? Quer dominar IA + automação + dados?</p>
        <a href="https://hotm.art/Q7nwN0pa" target="_blank" rel="noopener"
           class="cta-button secondary">Comunidade Impressionadora</a>
      </div>
    </footer>

    <footer class="container footer" data-html2canvas-ignore="true">
      <small>© 2025 Diagnóstico 5S 10X</small>
    </footer>

    <!-- WhatsApp flutuante (IGNORADO no PDF) -->
    <a class="whatsapp-float"
       href="https://wa.me/5594992993138?text=Ol%C3%A1!%20Quero%20falar%20sobre%20o%20Smart%205S%2010X"
       data-html2canvas-ignore="true" target="_blank" rel="noopener"
       aria-label="WhatsApp: 94 99299-3138">
      <span class="label">WhatsApp: 94 99299-3138</span>
      <svg viewBox="0 0 32 32" aria-hidden="true"><path d="M19.11 17.41c-..."/></svg>
    </a>

    <!-- ====== LIBS ====== -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0"></script>
    <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

    <!-- ====== SEU CÓDIGO (gráficos/CSV/botões) ====== -->
    <script src="js/resultado.js"></script>
    <script>
      // Topo dinâmico: mostra Responsável, Local e Data/Hora como no PDF
      document.addEventListener('DOMContentLoaded', () => {
        try {
          const el = document.getElementById('dados-resumo');
          if (!el) return;
          const profile = JSON.parse(localStorage.getItem('perfil5S') || '{}');
          const local = (localStorage.getItem('localTrabalho') || '').trim() || profile.company || '';
          const iso = localStorage.getItem('dataAvaliacaoISO');
          let d = iso ? new Date(iso) : new Date();
          if (isNaN(d.getTime())) d = new Date();
          const quando = d.toLocaleDateString('pt-BR') + ' ' + d.toLocaleTimeString('pt-BR');
          el.innerHTML = `<div style="background:#0b1220;color:#e5e7eb;border:1px solid #223047;border-radius:10px;padding:8px 12px">
            <strong>Responsável:</strong> ${profile.name || '-'}
            <span style="margin:0 8px">•</span>
            <strong>Local:</strong> ${local || '-'}
            <span style="margin:0 8px">•</span>
            <strong>E-mail:</strong> ${profile.email || '-'}
            <span style="margin:0 8px">•</span>
            <strong>Gerado em:</strong> ${quando}
          </div>`;
        } catch {}
      });
    </script>`n</script>

    <!-- ====== BIND ÚNICO DO BOTÃO PDF (remove handlers antigos) ====== -->
    <script>
      if (!window.__pdfBindOnce) {
        window.__pdfBindOnce = true;

        function rebindPdfButton() {
          const btn = document.getElementById('btnExportPDF');
          if (!btn) return;
          const clone = btn.cloneNode(true);
          clone.removeAttribute('onclick');       // mata onClicks legados
          clone.addEventListener('click', exportA4PDF, { passive: true });
          btn.parentNode.replaceChild(clone, btn);
        }

        window.addEventListener('DOMContentLoaded', () => {
          rebindPdfButton();
          // rebind extra caso algum script tente reanexar depois
          setTimeout(rebindPdfButton, 300);
          setTimeout(rebindPdfButton, 1000);

          // se o container de ações mudar, rebind novamente
          const actions = document.querySelector('.actions');
          if (actions) {
            new MutationObserver(() => rebindPdfButton())
              .observe(actions, { childList: true });
          }
        });
      }
    </script>

    <!-- removed legacy pdf block -->

  </body>
</html>
    <!-- ====== GERAÇÃO PDF SEM CORTES (bloco a bloco) ====== -->
    <script>
      async function exportA4PDF() {
        if (window.__pdfBusy) return; window.__pdfBusy = true; setTimeout(() => window.__pdfBusy = false, 1500);
        const { jsPDF } = window.jspdf; const reportEl = document.querySelector('#resultado'); if (!reportEl || !jsPDF) return;

        const qs = new URLSearchParams(location.search);
        function readChain(keys){ for (const k of keys){ const v=(localStorage.getItem(k) ?? sessionStorage.getItem(k) ?? '').trim(); if(v) return v; } return ''; }
        let responsavel = qs.get('responsavel') || readChain(['nomeResponsavel','responsavel','respNome','usuarioResponsavel']) || (document.querySelector('#nomeResponsavel, [name=nomeResponsavel]')?.value||'').trim() || (document.querySelector('[data-responsavel]')?.textContent||'').trim() || 'Responsavel nao informado';
        let localTrabalho = qs.get('local') || readChain(['localTrabalho','local','postoTrabalho','area']) || (document.querySelector('#localTrabalho, [name=localTrabalho]')?.value||'').trim() || (document.querySelector('[data-local]')?.textContent||'').trim() || 'Local nao informado';
        let iso = qs.get('data') || readChain(['dataAvaliacaoISO','dataISO','avaliacaoDataISO']); let d = iso ? new Date(iso) : new Date(); if (isNaN(d.getTime())) d = new Date();
        const dataBR = d.toLocaleDateString('pt-BR'); const horaBR = d.toLocaleTimeString('pt-BR');

        await new Promise(r => setTimeout(r, 450));

        // Monta Mini Consultoria e esconde blocos longos
        let __mini, __fbPrev, __drPrev, __actPrev;
        try {
          const fb = document.getElementById('feedback'); const dr = document.getElementById('dados-resumo'); const actions = reportEl.querySelector('.actions');
          if (fb) { __fbPrev = fb.getAttribute('data-html2canvas-ignore'); fb.setAttribute('data-html2canvas-ignore','true'); }
          if (dr) { __drPrev = dr.getAttribute('data-html2canvas-ignore'); dr.setAttribute('data-html2canvas-ignore','true'); }
          if (actions) { __actPrev = actions.getAttribute('data-html2canvas-ignore'); actions.setAttribute('data-html2canvas-ignore','true'); }

          const meta = (function(){ try{ return JSON.parse(localStorage.getItem('meta5S')||'null'); } catch { return null; } })();
          const keys = ['utilizacao','organizacao','limpeza','padronizacao','disciplina'];
          const titles = { utilizacao:'Utilizacao', organizacao:'Organizacao', limpeza:'Limpeza', padronizacao:'Padronizacao', disciplina:'Disciplina' };
          const rows = (meta && meta.senses) ? keys.map(k => { const avg = meta.senses[k]?.totals?.avg; return { key:k, title:titles[k], avg: typeof avg === 'number' ? avg : null }; }) : [];
          const m1 = rows.filter(r => r.avg != null && r.avg <= 1.0).sort((a,b)=>a.avg-b.avg).slice(0,2);
          const m2 = rows.filter(r => r.avg != null && r.avg > 1.0 && r.avg <= 1.7).sort((a,b)=>a.avg-b.avg).slice(0,2);
          const fortes = rows.filter(r => r.avg != null && r.avg > 2.5).sort((a,b)=>b.avg-a.avg).slice(0,2);
          function band(v){ if (v == null) return 'NA'; if (v <= 1.0) return 'M1'; if (v <= 1.7) return 'M2'; if (v <= 2.5) return 'M3'; return 'M4'; }

          const RISK = { utilizacao:['Estoque alto imobiliza capital','Acidentes por acumulacao','Perdas por obsolescencia'], organizacao:['Tempo de procura alto','Erros por itens fora de lugar','Paradas por falta de item'], limpeza:['Falhas de qualidade por contaminacao','Quebras nao detectadas','Risco ocupacional'], padronizacao:['Variacao de processo e resultado','Dificuldade de treinar/substituir','Aumento de refugos/atrasos'], disciplina:['Reincidencia de desvios','Baixa aderencia a padroes','Cultura fraca'] };
          const GAIN = { utilizacao:['Fluxo leve e rapido','Reducao de custos/espaco'], organizacao:['Menos tempo de procura','Qualidade e seguranca melhores'], limpeza:['Confiabilidade de equipamentos','Ambiente seguro/profissional'], padronizacao:['Previsibilidade e menos variacao','Onboarding rapido'], disciplina:['Constancia e manutencao','Cultura de melhoria'] };
          const ACTIONS = { utilizacao:['Mapear por frequencia (D/U/M/R)','Etiqueta vermelha e remover ociosos','Area de quarentena com prazo','Definir niveis min/max por consumo','Realocar itens raros fora da area de valor'], organizacao:['Enderecar e etiquetar prateleiras','Sombrear ferramentas (locais fixos)','Limites visuais/divisorias nos kits','Regra dos 2 minutos para localizar','Kits por tarefa com checklist'], limpeza:['Rotina diaria 5-10 min por area','Inspecao-limpeza (achar fontes)','Tratativas: vedacoes/protecoes/bandejas','Checklist com data/assinatura','Foto antes/depois nos pontos criticos'], padronizacao:['Instrucoes visuais 1 pagina','Treino rapido no posto','Checklist de confirmacao','Auditoria semanal das variacoes','Repositorio unico dos padroes'], disciplina:['Reuniao diaria 10 min','Quadro visivel de indicadores 5S','Reconhecer boas praticas','Plano de acao com responsavel/prazo','Revisao quinzenal com evidencias'] };

          const badgeM1 = '<span style="display:inline-block;background:#fee2e2;color:#991b1b;border:1px solid #fecaca;border-radius:6px;padding:1px 6px;font-weight:700">M1 ??</span>';
          const badgeM2 = '<span style="display:inline-block;background:#fef3c7;color:#92400e;border:1px solid #fde68a;border-radius:6px;padding:1px 6px;font-weight:700">M2 ?</span>';
          const badgeM3 = '<span style="display:inline-block;background:#dbeafe;color:#1e40af;border:1px solid #bfdbfe;border-radius:6px;padding:1px 6px;font-weight:700">M3 ?</span>';
          const badgeM4 = '<span style="display:inline-block;background:#dcfce7;color:#065f46;border:1px solid #bbf7d0;border-radius:6px;padding:1px 6px;font-weight:700">M4 ??</span>';

          let html = '<div style="font-size:11px;line-height:1.35">'
            + '<h3 style="margin:0 0 6px">Mini Consultoria - Parecer do Auditor</h3>'
            + '<p style="margin:0 0 6px;color:#9ca3af">Notas baixas recebem destaque visual. Trate M1 em 48h e M2 em 7 dias.</p>';

          if (m1.length){
            html += '<p><strong>Alertas (48h):</strong></p><ul style="margin:4px 0 8px;list-style:none;padding:0">';
            m1.forEach(f=>{
              html += '<li style="background:#1f2937;border:1px solid #374151;border-radius:8px;padding:6px 8px;margin:4px 0">'
                + badgeM1 + ' <strong>' + f.title + '</strong> ' + (f.avg?.toFixed(1)||'-')
                + ' — Riscos: ' + (RISK[f.key]||[]).slice(0,2).join('; ')
                + ' • Prazo: 48h.</li>;
            });
            html += '</ul>';
          }

          if (m2.length){
            html += '<p><strong>Focos (7 dias):</strong></p><ul style="margin:4px 0 8px;list-style:none;padding:0">';
            m2.forEach(f=>{
              html += '<li style="background:#111827;border:1px solid #374151;border-radius:8px;padding:6px 8px;margin:4px 0">'
                + badgeM2 + ' <strong>' + f.title + '</strong> ' + (f.avg?.toFixed(1)||'-')
                + ' — Riscos: ' + (RISK[f.key]||[]).slice(0,2).join('; ')
                + ' • Prazo: 7 dias.</li>;
            });
            html += '</ul>';
          }

          if (fortes.length){
            html += '<p><strong>Ganhos:</strong></p><ul style="margin:4px 0 8px;list-style:none;padding:0">';
            fortes.forEach(f=>{
              const badge = (f.avg>2.5 && f.avg<2.8) ? badgeM3 : badgeM4;
              html += '<li style="background:#0b1220;border:1px solid #223047;border-radius:8px;padding:6px 8px;margin:4px 0">'
                + badge + ' <strong>' + f.title + '</strong> ' + (f.avg?.toFixed(1)||'-')
                + ' — Ganhos: ' + (GAIN[f.key]||[]).slice(0,2).join('; ')
                + '</li>';
            });
            html += '</ul>';
          }

          const prioridade = m1.concat(m2).slice(0,2);
          if (prioridade.length){
            html += '<p><strong>Plano de acao (7/14/30):</strong></p>';
            prioridade.forEach(f=>{
              html += '<p style="margin:4px 0"><em>' + f.title + ' (' + (f.avg?.toFixed(1)||'-') + ')</em></p>'
                + '<ul style="margin:0 0 8px;list-style:none;padding:0">'
                + (ACTIONS[f.key]||[])\.slice(0,2).map(a=>'\n<li style="border-left:3px solid #334155;padding:2px 8px;margin:3px 0">?? ' + a + '</li>').join('')
                + '</ul>';
            });
          }
          // Impactos por Pilar (Financeiro, Imagem, Meio Ambiente, SSO, Produtividade)
          try {
            const PILLAR = {
              utilizacao:{ FIN:['Capital imobilizado e perdas por obsolescencia'], IMG:['Ambiente desorganizado prejudica percepcao'], AMB:['Excesso gera descarte/sucata'], SSO:['Acidentes por acumulacao/obstrucao'], PROD:['Fluxo lento e retrabalho'] },
              organizacao:{ FIN:['Tempo de procura custa horas extras'], IMG:['Erros/atrasos afetam reputacao'], AMB:['Deslocamentos desnecessarios aumentam impacto'], SSO:['Itens fora de lugar geram incidentes'], PROD:['Baixa velocidade e confiabilidade'] },
              limpeza:{ FIN:['Falhas/refugos aumentam custo'], IMG:['Percepcao de descuido'], AMB:['Contaminacao gera descarte'], SSO:['Quedas/poeira comprometem saude'], PROD:['Paradas nao planejadas'] },
              padronizacao:{ FIN:['Variacao gera retrabalho'], IMG:['Experiencia desigual do cliente'], AMB:['Processos sem controle geram desperdicio'], SSO:['Execucao irregular aumenta riscos'], PROD:['Resultados instaveis'] },
              disciplina:{ FIN:['Ganhos nao mantidos se perdem'], IMG:['Inconstancia reduz credibilidade'], AMB:['Acumulos recorrentes'], SSO:['Desvios repetidos aumentam exposicao'], PROD:['Oscilacao de desempenho'] }
            };
            const pillars = { FIN:[], IMG:[], AMB:[], SSO:[], PROD:[] };
            m1.concat(m2).forEach(f=>{ const p=PILLAR[f.key]||{}; for (const k in pillars){ if (p[k] && pillars[k].length < 2) pillars[k].push(p[k][0]); } });
            const pillBadge = (label,bg,color,border) => '<span style="display:inline-block;background:'+bg+';color:'+color+';border:1px solid '+border+';border-radius:6px;padding:1px 6px;font-weight:700;margin-right:6px">'+label+'</span>';
            const PB = {
              FIN: pillBadge('Financas','#fee2e2','#991b1b','#fecaca'),
              IMG: pillBadge('Imagem','#e0e7ff','#3730a3','#c7d2fe'),
              AMB: pillBadge('Meio Ambiente','#dcfce7','#065f46','#bbf7d0'),
              SSO: pillBadge('Saude & Seguranca','#fde68a','#92400e','#fde68a'),
              PROD: pillBadge('Produtividade','#e5e7eb','#111827','#d1d5db')
            };
            const pillOrder = ['FIN','IMG','AMB','SSO','PROD'];
            if (pillOrder.some(k => pillars[k].length)){
              html += '<p><strong>Impactos por Pilar:</strong></p><ul style="margin:4px 0 8px;list-style:none;padding:0">';
              pillOrder.forEach(k=>{ if (pillars[k].length){ html += '<li style="margin:3px 0">' + PB[k] + pillars[k].join('; ') + '.</li>'; } });
              html += '</ul>';
            }
          } catch {}

          // Reconhecimento para notas altas (manter e compartilhar padroes)
          try {
            if (fortes.length){
              html += '<p><strong>Reconhecimentos:</strong></p><ul style="margin:4px 0 8px;list-style:none;padding:0">';
              fortes.forEach(f=>{
                html += '<li style="background:#0b1220;border:1px solid #223047;border-radius:8px;padding:6px 8px;margin:4px 0">'
                     + '<span style="display:inline-block;background:#dcfce7;color:#065f46;border:1px solid #bbf7d0;border-radius:6px;padding:1px 6px;font-weight:700;margin-right:6px">OK</span>'
                     + '<strong>' + f.title + '</strong> ' + (f.avg!=null?f.avg.toFixed(1):'-') + ' - Manter padrao, registrar boas praticas e treinar novos membros.'
                     + '</li>';
              });
              html += '</ul>';
            }
          } catch {}

          html += '<p style="color:#6b7280;margin-top:6px">Estrategia: 7 dias conter riscos; 14 dias padronizar/treinar; 30 dias auditar/estabilizar.</p></div>';
          __mini = document.createElement('div');
          __mini.className = 'card';
          __mini.style.marginTop = '12px';
          __mini.innerHTML = html;
          const chartCard = document.getElementById('chartSenso')?.closest('.card');
          const overallEl = document.getElementById('overallCard');
          const tituloEl = reportEl.querySelector('h2');

          // Agrupa título + Nota Geral + Gráfico + MiniConsultoria em um único bloco (evita quebra entre eles)
          var __cluster, __ovPrev, __chartPrev, __titPrev;
          try {
            __cluster = document.createElement('div');
            __cluster.id = '__pdfClusterResumo';
            __cluster.style.marginTop = '10px';

            if (tituloEl) {
              __titPrev = tituloEl.getAttribute('data-html2canvas-ignore');
              tituloEl.setAttribute('data-html2canvas-ignore','true');
              __cluster.appendChild(tituloEl.cloneNode(true));
            }
            if (overallEl) {
              __ovPrev = overallEl.getAttribute('data-html2canvas-ignore');
              overallEl.setAttribute('data-html2canvas-ignore','true');
              __cluster.appendChild(overallEl.cloneNode(true));
            }
            if (chartCard) {
              __chartPrev = chartCard.getAttribute('data-html2canvas-ignore');
              chartCard.setAttribute('data-html2canvas-ignore','true');
              __cluster.appendChild(chartCard.cloneNode(true));
            }
            __cluster.appendChild(__mini);

            (chartCard || reportEl).insertAdjacentElement('afterend', __cluster);
          } catch {
            // fallback: se cluster falhar, insere mini abaixo do gráfico
            (chartCard || reportEl).insertAdjacentElement('afterend', __mini);
          }
        } catch {}

        // PDF sem cortes: posiciona cada filho do relatório
        const pdf = new jsPDF('p','mm','a4'); const W = pdf.internal.pageSize.getWidth(); const H = pdf.internal.pageSize.getHeight();
        const LEFT=8, RIGHT=8, TOP=30, BOTTOM=6, GAP=3; const usableW=W-LEFT-RIGHT, usableH=H-TOP-BOTTOM;
        function header(){ pdf.setFillColor(10,25,47); pdf.rect(0,0,W,25,'F'); pdf.setTextColor(255,255,255); pdf.setFontSize(10); pdf.text('Relatorio Diagnostico 5S | ZADONI CRIACOES - WhatsApp: 94992993138 - Projeto S11D', 10, 10); pdf.text(`Responsavel: ${responsavel}`, 10, 16); pdf.text(`Local: ${localTrabalho}`, 10, 22); pdf.text(`Data: ${dataBR} | Hora: ${horaBR}`, W-80, 22); }
        header(); let cursorY = TOP;
        async function place(el){ const canvas = await html2canvas(el,{ scale:2, useCORS:true, allowTaint:true, scrollX:0, scrollY:-window.scrollY, windowWidth:document.documentElement.scrollWidth, windowHeight:document.documentElement.scrollHeight }); const aspect = canvas.height/canvas.width; let drawW=usableW, drawH=drawW*aspect; if(drawH>usableH){ const k=usableH/drawH; drawW*=k; drawH*=k; } if(cursorY+drawH>H-BOTTOM){ pdf.addPage(); header(); cursorY=TOP; } const x=(W-drawW)/2; pdf.addImage(canvas.toDataURL('image/png'),'PNG',x,cursorY,drawW,drawH); cursorY+=drawH+GAP; }
        const children = Array.from(reportEl.children).filter(n => n.nodeType===1 && n.getAttribute('data-html2canvas-ignore')!=='true');
        for(const child of children){ await place(child); }

        const nameSan = responsavel.replace(/\s+/g,'_'); const dateSan = dataBR.replace(/\//g,'-'); pdf.save(`Relatorio_5S_${nameSan}_${dateSan}.pdf`);

        // Limpeza
        try {
          if (typeof __cluster !== 'undefined' && __cluster) __cluster.remove();
          if (__mini) __mini.remove();
          const fb=document.getElementById('feedback');
          const dr=document.getElementById('dados-resumo');
          const actions=reportEl.querySelector('.actions');
          const chartCard=document.getElementById('chartSenso')?.closest('.card');
          const overallEl=document.getElementById('overallCard');
          const tituloEl=reportEl.querySelector('h2');
          if(fb){ if(__fbPrev==null) fb.removeAttribute('data-html2canvas-ignore'); else fb.setAttribute('data-html2canvas-ignore',__fbPrev);} 
          if(dr){ if(__drPrev==null) dr.removeAttribute('data-html2canvas-ignore'); else dr.setAttribute('data-html2canvas-ignore',__drPrev);} 
          if(actions){ if(__actPrev==null) actions.removeAttribute('data-html2canvas-ignore'); else actions.setAttribute('data-html2canvas-ignore',__actPrev);} 
          if(chartCard){ if(__chartPrev==null) chartCard.removeAttribute('data-html2canvas-ignore'); else chartCard.setAttribute('data-html2canvas-ignore',__chartPrev); }
          if(overallEl){ if(__ovPrev==null) overallEl.removeAttribute('data-html2canvas-ignore'); else overallEl.setAttribute('data-html2canvas-ignore',__ovPrev); }
          if(tituloEl){ if(__titPrev==null) tituloEl.removeAttribute('data-html2canvas-ignore'); else tituloEl.setAttribute('data-html2canvas-ignore',__titPrev); }
        } catch {}
      }
    </script>


<script>window.addEventListener('DOMContentLoaded',()=>{ try{ window.generatePDF = exportA4PDF; }catch{} });</script>



<style>
  :root{ --ok:#22C55E; --warn:#F59E0B; --bad:#EF4444; --panel:#0F172A; --ink:#E5E7EB; }
  #reportRoot{ width:794px; margin:0 auto; color:var(--ink); font: 13px/1.4 system-ui, -apple-system, Segoe UI, Roboto, Arial; }
  .rep-panel{ background:var(--panel); border:1px solid #1f2a44; border-radius:12px; padding:12px 14px; margin:8px 0; }
  .rep-row{ display:flex; gap:12px; flex-wrap:wrap; align-items:flex-start; }
  .rep-col{ flex:1 1 320px; min-width:0; }
  .tag{ display:inline-block; padding:2px 8px; border-radius:9999px; font-weight:700; font-size:12px; vertical-align:middle; }
  .tag.bad{ background:#fee2e2; color:#991b1b; border:1px solid #fecaca; }
  .tag.warn{ background:#fef3c7; color:#92400e; border:1px solid #fde68a; }
  .tag.ok{ background:#dcfce7; color:#065f46; border:1px solid #bbf7d0; }
  .muted{ color:#9ca3af; }
  .list{ margin:6px 0 0; padding-left:16px; }
  .list li{ margin:2px 0; }
  .pill{ display:inline-flex; align-items:center; gap:6px; }
  .h-row{ display:flex; justify-content:space-between; gap:8px; flex-wrap:wrap; }
  .small{ font-size:12px; }
  .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; }
  .sep{ height:1px; background:#223047; margin:8px 0; }
  .center{ text-align:center; }
  .bar-img{ display:block; width:100%; max-height:160px; object-fit:contain; }
  .pb-after{ page-break-after:always; }
</style>
<script src="https://cdn.jsdelivr.net/npm/html2pdf.js@0.10.1/dist/html2pdf.bundle.min.js"></script>
<script>
  let __pdfOnce=false;
  function to03(x){ if(x==null||x==='') return null; const n=Number(x); if(Number.isNaN(n)) return null; if(n<=3) return Math.max(0,Math.min(3,n)); if(n<=10) return Math.max(0,Math.min(3,(n/10)*3)); return null; }
  function classify(v){ if(v==null) return 'med'; if(v<=1.5) return 'bad'; if(v<=2.2) return 'med'; return 'good'; }
  function readScores(){ let m=null; try{ m=JSON.parse(localStorage.getItem('meta5S')||'null'); }catch{}; const s=m?.senses; const avg=(o)=>to03(o?.totals?.avg); let U=s?avg(s.utilizacao):null; let O=s?avg(s.organizacao):null; let L=s?avg(s.limpeza):null; let P=s?avg(s.padronizacao):null; let D=s?avg(s.disciplina):null; const qs=new URLSearchParams(location.search); U=to03(U ?? qs.get('U') ?? qs.get('utilizacao')); O=to03(O ?? qs.get('O') ?? qs.get('organizacao') ?? qs.get('ordenacao')); L=to03(L ?? qs.get('L') ?? qs.get('limpeza')); P=to03(P ?? qs.get('P') ?? qs.get('padronizacao')); D=to03(D ?? qs.get('D') ?? qs.get('disciplina')); const arr=[U,O,L,P,D].filter(v=>typeof v==='number'); const overall=arr.length?(arr.reduce((a,b)=>a+b,0)/arr.length):null; return {U,O,L,P,D,overall}; }
  function profile(){ let pf={}; try{ pf=JSON.parse(localStorage.getItem('perfil5S')||'{}'); }catch{}; const loc=(localStorage.getItem('localTrabalho')||'').trim(); const iso=localStorage.getItem('dataAvaliacaoISO'); let d=iso?new Date(iso):new Date(); if(isNaN(d)) d=new Date(); return { name:pf.name||'-', email:pf.email||'-', company:pf.company||'', local:loc||pf.company||'-', date:d.toLocaleDateString('pt-BR'), time:d.toLocaleTimeString('pt-BR') } }
  const SENSE_TITLES={U:'Utilização',O:'Ordenação',L:'Limpeza',P:'Padronização',D:'Disciplina'};
  function summaryForSense(k,v){ const level=classify(v); const title=SENSE_TITLES[k]; const bullets=[]; if(level==='bad'){ if(k==='U') bullets.push('Remover sucata/ociosos e liberar corredores'); if(k==='O') bullets.push('Endereçar materiais e kits por tarefa'); if(k==='L') bullets.push('Housekeeping 10min e contenção de óleo/poeira'); if(k==='P') bullets.push('Padronizar torque/etiquetas e plano de içamento'); if(k==='D') bullets.push('APR/PT/LOTO e check diário do gestor'); bullets.push('Nominar dono da ação e prazo 48h'); } else if(level==='med'){ if(k==='U') bullets.push('Definir min–max de consumíveis no posto'); if(k==='O') bullets.push('Sombrear ferramentas e sinalizar rotas'); if(k==='L') bullets.push('Checklist simples por turno'); if(k==='P') bullets.push('Instrução visual 1 página no posto'); if(k==='D') bullets.push('Ronda 5S diária (10 min)'); bullets.push('Registrar fotos antes/depois'); } else { bullets.push('Manter padrão, auditar semanal e compartilhar'); } return { level, title, bullets } }
  function makeSafeFileName(){ const pf=profile(); const nm=(pf.name||'Usuario').replace(/[^\p{L}0-9_\- ]/gu,'').replace(/\s+/g,'_'); return `Resumo_5S_${nm}_${(new Date()).toISOString().slice(0,10)}`; }
  function buildSummaryDOM(scores){ const pf=profile(); const root=document.createElement('div'); root.id='reportRoot'; const head=document.createElement('div'); head.className='rep-panel'; head.innerHTML=`<div class="h-row small"><div><strong>${pf.name}</strong> • <span class="mono">${pf.email}</span></div><div><strong>Local:</strong> ${pf.local}</div><div>${pf.date} ${pf.time}</div></div>`; root.appendChild(head); const top=document.createElement('div'); top.className='rep-panel'; const bars=[scores.U,scores.O,scores.L,scores.P,scores.D].map(v=> (v==null?'-':v.toFixed(1))).join(' | '); const overall=(scores.overall!=null)? scores.overall.toFixed(1): '-'; let chartImgHtml=''; try{ const cv=document.getElementById('chartSenso'); if(cv){ chartImgHtml=`<img class="bar-img" alt="Gráfico 5S" src="${cv.toDataURL('image/png')}"/>`; } }catch{} top.innerHTML=`<div class="h-row"><div><strong>Nota Geral:</strong> ${overall}</div><div class="muted small mono">U|O|L|P|D = ${bars}</div></div>${chartImgHtml}`; root.appendChild(top); const res=document.createElement('div'); res.className='rep-panel'; const senseOrder=['U','O','L','P','D']; const blocks=senseOrder.map(k=>({k, s:scores[k], sum: summaryForSense(k, scores[k]) })); const items=blocks.map(({k,s,sum})=>{ const badge=sum.level==='bad'? '<span class="tag bad">?? Ruim</span>' : sum.level==='med'? '<span class="tag warn">? Médio</span>' : '<span class="tag ok">? Bom</span>'; const bullets=sum.bullets.slice(0, sum.level==='bad'?3: sum.level==='med'?2:1).map(b=>`<li>${b}</li>`).join(''); const scoreTxt=(typeof s==='number')? s.toFixed(1) : '-'; return `<div class="rep-col"><div class="pill"><strong>${sum.title}</strong><span class="muted">${scoreTxt}</span>${badge}</div><ul class="list small">${bullets}</ul></div>`; }).join(''); res.innerHTML=`<h3 style="margin:0 0 6px">Resumo Inteligente</h3><div class="rep-row">${items}</div>`; root.appendChild(res); const br=document.createElement('div'); br.className='pb-after sep'; root.appendChild(br); const plan=document.createElement('div'); plan.className='rep-panel'; const pairs=blocks.sort((a,b)=> (a.s??99)-(b.s??99)); const tasks=[]; for(const it of pairs){ if(tasks.length>=7) break; const lvl=classify(it.s); if(lvl==='good') continue; const base=it.sum.title; const cand=it.sum.bullets; for(const c of cand){ if(tasks.length>=7) break; tasks.push(`${base}: ${c}`); } } while(tasks.length<5) tasks.push('Auditar rotina 5S diária • Dono: ______ • KPI: 1 foto antes/depois'); const trimmed=tasks.slice(0,7).map(t=> (t.length>100? t.slice(0,97)+'…': t)); plan.innerHTML=`<h3 style="margin:0 0 6px">Plano de 7 Dias</h3><ol class="list small">${trimmed.map(t=>`<li>${t} • Dono: ______ • KPI: OK/NG</li>`).join('')}</ol>`; root.appendChild(plan); const badCount=blocks.filter(x=> classify(x.s)==='bad').length; if(badCount>=2){ const foot=document.createElement('div'); foot.className='small muted center'; foot.textContent='Nota: 2+ sensos ruins indicam risco de segurança e custo. Priorize ação imediata nas frentes.'; root.appendChild(foot); } return root; }
  async function exportA4PDF(){ if(__pdfOnce) return; __pdfOnce=true; setTimeout(()=>__pdfOnce=false,1500); const data=readScores(); const node=buildSummaryDOM(data); document.body.appendChild(node); const opt={ margin:[8,8,8,8], filename: makeSafeFileName(), image:{type:'jpeg',quality:0.98}, html2canvas:{scale:2,useCORS:true,letterRendering:true}, jsPDF:{unit:'mm',format:'a4',orientation:'portrait'}, pagebreak:{mode:['css','legacy']} }; try{ await html2pdf().from(node).set(opt).save(); } finally { node.remove(); } }
  window.exportA4PDF = exportA4PDF;
</script>

<style>
  /* Action Plan responsive styles */
  :root{ --ok:#22C55E; --warn:#F59E0B; --bad:#EF4444; --panel:#0F172A; --ink:#E5E7EB; }
  .ap-card{ background:var(--panel); border:1px solid #1f2a44; border-radius:12px; padding:12px; box-shadow:0 2px 6px rgba(0,0,0,.18); color:var(--ink); }
  .ap-grid{ display:grid; grid-template-columns: repeat(2, minmax(0,1fr)); gap:12px; }
  @media (max-width: 720px){ .ap-grid{ grid-template-columns: 1fr; } }
  .ap-bad{ border-left:4px solid var(--bad); }
  .ap-med{ border-left:4px solid var(--warn); }
  .ap-ok{ border-left:4px solid var(--ok); }
  .tag{ display:inline-block; padding:2px 8px; border-radius:9999px; font-weight:700; font-size:12px; }
  .tag.bad{ background:#FEE2E2; color:#B91C1C; }
  .tag.med{ background:#FEF3C7; color:#92400E; }
  .tag.ok{  background:#DCFCE7; color:#166534; }
  .deadline{ float:right; font-size:11px; opacity:.9; }
  #reportRoot{ width:794px; margin:0 auto; }
  .avoid-break{ break-inside:avoid; page-break-inside:avoid; }
</style>
<script>
  (function(){
    let isGenerating = false;
    function to03(x){ if(x==null||x==='') return null; const n=Number(x); if(Number.isNaN(n)) return null; if(n<=3) return Math.max(0,Math.min(3,n)); if(n<=10) return Math.max(0,Math.min(3,(n/10)*3)); return null; }
    function classify(v){ if(v==null) return 'med'; if(v<=1.5) return 'bad'; if(v<=2.2) return 'med'; return 'good'; }
    const TITLES={U:'Utiliza&ccedil;&atilde;o',O:'Ordena&ccedil;&atilde;o',L:'Limpeza',P:'Padroniza&ccedil;&atilde;o',D:'Disciplina'};
    function readScores(){ let m=null; try{ m=JSON.parse(localStorage.getItem('meta5S')||'null'); }catch{}; const s=m?.senses; const avg=o=>to03(o?.totals?.avg); let U=s?avg(s.utilizacao):null; let O=s?avg(s.organizacao):null; let L=s?avg(s.limpeza):null; let P=s?avg(s.padronizacao):null; let D=s?avg(s.disciplina):null; const qs=new URLSearchParams(location.search); U=to03(U ?? qs.get('U') ?? qs.get('utilizacao')); O=to03(O ?? qs.get('O') ?? qs.get('organizacao') ?? qs.get('ordenacao')); L=to03(L ?? qs.get('L') ?? qs.get('limpeza')); P=to03(P ?? qs.get('P') ?? qs.get('padronizacao')); D=to03(D ?? qs.get('D') ?? qs.get('disciplina')); return {U,O,L,P,D}; }
        function planFor(k,v){
      const lvl = classify(v);
      const title = TITLES[k]+' — Status: '+(lvl==='bad'?'Ruim':(lvl==='med'?'M&eacute;dio':'Bom'));
      const badge = lvl==='bad' ? '<span class="tag bad">Ruim</span>' : lvl==='med' ? '<span class="tag med">M&eacute;dio</span>' : '<span class="tag ok">Bom</span>';
      const dl = (lvl==='bad')?'48h':(lvl==='med')?'7d':'14d';
      const SUG = {
        U: {
          bad: [
            'Remover sucata/ociosos; liberar corredores da frente de trabalho',
            'Definir min–max de consum&iacute;veis (abrasivos, eletrodos, graxas) no posto',
            'Realocar andaimes/gabaritos fora de uso e liberar racks'
          ],
          med: [
            'Revisar kits por tarefa (spool/linha) com checklist',
            'Segregar &amp; destinar itens raros para &aacute;rea remota'
          ],
          good: [ 'Manter fluxos visuais; auditar semanalmente' ],
        },
        O: {
          bad: [
            'Endere&ccedil;ar canteiro: baias (areia/brita/cimento) e almoxarifado',
            'Racks/cavaletes para tubos, vigas e chapas com identifica&ccedil;&atilde;o',
            'Sombrear ferramentas por equipe; sinalizar rotas/&aacute;reas de exclus&atilde;o'
          ],
          med: [
            'Padronizar etiquetas/cores; aplicar teste de 2 minutos',
            'Criar kits por tarefa (montagem mec&acirc;nica) com confer&ecirc;ncia'
          ],
          good: [ 'Sustentar endere&ccedil;amento e indicadores de localiza&ccedil;&atilde;o' ],
        },
        L: {
          bad: [
            'Housekeeping 10min/turno; conter &oacute;leo/poeira (caminh&atilde;o pipa/aspersores)',
            'Res&iacute;duos classe I/II em ca&ccedil;ambas identificadas; ponto de coleta por frente',
            'Kit de conten&ccedil;&atilde;o de &oacute;leo; limpar pontos cr&iacute;ticos (foto antes/depois)'
          ],
          med: [
            'Checklist simples por &aacute;rea; tratar fontes de sujeira',
            'Inspecionar dutos/salas t&eacute;cnicas; remover rebarbas/esc&oacute;ria'
          ],
          good: [ 'Manter rotina e evid&ecirc;ncias fotogr&aacute;ficas' ],
        },
        P: {
          bad: [
            'Torque/etiquetas padronizados; plano de i&ccedil;amento (NR‑18/NR‑35)',
            'Instru&ccedil;&atilde;o visual (1 p&aacute;gina) por posto; tagueamento de linhas/v&aacute;lvulas',
            'Registros/Certificados de torque e testes no posto'
          ],
          med: [
            'Treino r&aacute;pido on‑the‑job',
            'Auditar varia&ccedil;&otilde;es semanalmente e tratar desvios'
          ],
          good: [ 'Compartilhar padr&atilde;o com outras frentes' ],
        },
        D: {
          bad: [
            'APR/PT/AUDITORIAS; confer&ecirc;ncia do gestor (10min) no in&iacute;cio do turno',
            'Reuni&atilde;o 5S di&aacute;ria (10min) com registro e foto',
            'Reconhecer equipe segura do m&ecirc;s; plano com dono &amp; prazo'
          ],
          med: [
            'Quadro simples de indicadores por frente',
            'Reconhecer boas pr&aacute;ticas; auditoria r&aacute;pida semanal'
          ],
          good: [ 'Sustentar disciplina; manter DDS e evid&ecirc;ncias' ],
        },
      };
      const pick = (arr,n)=>arr.slice(0,n);
      const bullets = (lvl==='bad') ? pick(SUG[k].bad,3) : (lvl==='med') ? pick(SUG[k].med,2) : pick(SUG[k].good,1);
      return { lvl, title, badge, bullets, deadline: dl };
    }    return {lvl:title.includes('BAD')?'bad':(title.includes('MED')?'med':'ok'), title, badge, bullets, deadline:dl}; }
    function ensureActionPlan(){ const scores=readScores(); const order=['U','O','L','P','D']; const containerId='actionPlan'; let cont=document.getElementById(containerId); if(!cont){ const chartCard=document.getElementById('chartSenso')?.closest('.card'); cont=document.createElement('section'); cont.id=containerId; cont.className='card'; if(chartCard) chartCard.insertAdjacentElement('afterend', cont); else document.querySelector('#resultado')?.appendChild(cont); }
      const grid=document.createElement('div'); grid.className='ap-grid';
      order.forEach(k=>{ const v=scores[k]; const p=planFor(k,v); const st = p.lvl==='bad'?'ap-card ap-bad avoid-break': p.lvl==='med'?'ap-card ap-med avoid-break':'ap-card ap-ok avoid-break'; const lis=p.bullets.slice(0,3).map(b=>`<li>${b}</li>`).join(''); const risk = (classify(v)==='bad')? '<div style="color:#fca5a5;margin-top:6px">Atenção: risco de custo/segurança se não tratado.</div>' : '';
        const card=`<div class="${st}"><div><span class="deadline">${p.deadline}</span><strong>${p.title}</strong> ${p.badge}</div><ul style="margin:6px 0 0 18px">${lis}</ul><div class="small" style="margin-top:4px">Owner: ______</div>${risk}</div>`; grid.insertAdjacentHTML('beforeend', card); });
      cont.innerHTML = `<div class="ap-card" style="margin-bottom:8px"><strong>Plano de A&ccedil;&atilde;o</strong> <span class="small" style="opacity:.8">(gerado automaticamente)</span></div>`;
      cont.appendChild(grid);
    }
    async function exportA4PDF(){ if(isGenerating) return; isGenerating=true; setTimeout(()=>isGenerating=false,1200); const scores=readScores(); ensureActionPlan(); const node=document.createElement('div'); node.id='reportRoot';
      const hdr=document.getElementById('dados-resumo'); if(hdr) node.appendChild(hdr.cloneNode(true));
      const chart=document.getElementById('chartSenso'); if(chart){ try{ const img=document.createElement('img'); img.className='bar-img'; img.src=chart.toDataURL('image/png'); const wrap=document.createElement('div'); wrap.className='ap-card avoid-break'; wrap.appendChild(img); node.appendChild(wrap); }catch{} }
      // Clone Action Plan compact
      const ap=document.getElementById('actionPlan'); if(ap) node.appendChild(ap.cloneNode(true));
      document.body.appendChild(node);
      const opt={ margin:[8,8,8,8], filename: 'Relatorio_5S_Acao', image:{type:'jpeg',quality:0.98}, html2canvas:{scale:2,useCORS:true,letterRendering:true}, jsPDF:{unit:'mm',format:'a4',orientation:'portrait'}, pagebreak:{mode:['css','legacy']} };
      try{ await html2pdf().from(node).set(opt).save(); } finally { node.remove(); }
    }
    // expose and init
    window.exportA4PDF = exportA4PDF;
    document.addEventListener('DOMContentLoaded', ensureActionPlan);
  })();
</script>


